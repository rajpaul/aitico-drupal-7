<?php

/*
 * Generic Ajax reply implementaion
 * @param $success (status)
 * @param $data (response)
 */

function aitico_core_ajax_reply($success, $data = null) {
    drupal_json_output(array(
        'success' => $success,
        'data' => $data,
    ));
}

/**
 * Override of the standard user deletion page. Shows a confirmation box
 * with the user profile visible underneath.
 */
function aitico_core_page_user_delete($user) {
    module_load_include('inc', 'user', 'user.pages');
    $title = "Delete User";
    //$title = t("Delete user @name?", array('@name' => _aitico_user_name($user->uid)));
    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => render(drupal_get_form('user_cancel_confirm_form', $user))));
}

/**
 * Password Change
 * @param type $uid
 * @return type 
 */
function change_user_password() {
    global $user;
    $title = "Change Password";
    // $account = user_load($uid);
    $account = $user;
    $form = drupal_get_form('aitico_core_password_form', $account);
    $change_password_form = drupal_render($form);

    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => $change_password_form));
}

/**
 * Check user is company admin for a specific Company
 * @param : company_id
 * 
 */
function is_company_admin($comany_id) {
    global $user;
    $check_company_admin = db_query("SELECT ucs.* , ur.* FROM {users_companies_sites} ucs , {users_roles} ur 
                    WHERE ucs.uid = ur.uid AND ur.rid = :rid AND ucs.cid = :cid
                    AND ur.uid = :uid", array(':rid' => 6, ':cid' => $comany_id, ':uid' => $user->uid)
            )->fetchAll();
    if (!empty($check_company_admin)) {
        return TRUE;
    } else {
        return FALSE;
    }
}

/**
 * Add user form
 * @return theme
 */
function add_user_form($companyId, $siteId=0) {
    $is_company_admin = is_company_admin($companyId); 
    if(!$is_company_admin)
        drupal_access_denied();
    $user_form = render(drupal_get_form('aitico_core_user_form', $companyId, $siteId));
    $title = "Edit User";
    return theme('content_entry_page', array('form_title' => $title,
                'node_add_form' => $user_form));
}

/**
 * User edit form
 * @param type $uid
 */
function edit_user_form($uid) {
    if(!$is_company_admin)
        drupal_access_denied();
    $user = user_load($uid);
    $title = "Edit User";
    $user_form = render(drupal_get_form('aitico_core_user_edit_form', $user));
    return theme('content_entry_page', array('form_title' => $title,
                'node_add_form' => $user_form));
}

/**
 * Get user list
 * 
 * @return template 
 */
function user_render($company_id, $site_id = null) {
    //query for user list
    $user_sql = "SELECT u.*,ucs.cid,ucs.sid,r.name as role 
            FROM {users} u ,{users_companies_sites} ucs,{users_roles} ur,{role} r 
            WHERE ucs.uid = u.uid AND ur.uid=u.uid AND ur.rid = r.rid AND ucs.cid = $company_id";
    if (isset($site_id) && $site_id != "0") {
        $user_sql .= " AND ucs.sid = $site_id";
    }
    $user_list = db_query($user_sql)->fetchAll(PDO::FETCH_ASSOC);

    //return theme('aco_user_list', array('user_lists' => $user_res));

    return $user_list;
}

/**
 *
 * @param type $nid
 * @return type 
 * 
 */
function delete_aitico_node_form($nid) {
    $node = node_load($nid);
    $title = "Delete";
    $node_edit_form = drupal_render(drupal_get_form('node_delete_confirm', $node));
    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => $node_edit_form));
}

/**
 *
 * @param type $nid
 * @return type 
 * 
 */
function edit_aitico_node_form($node) {
    module_load_include('inc', 'node', 'node.pages');
    $title = "Edit";
    $node_edit_form = drupal_render(drupal_get_form($node->type . '_node_form', $node));
    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => $node_edit_form));
}

/**
 * Site form
 * @return type 
 */
function add_site_form() {
    $title = t("Add Site");
    $node_type = 'site';
    $site_form = get_aitico_node_form($node_type);
    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => $site_form));
}

/**
 * Charging station form
 * @return type 
 * 
 */
function add_charging_station_form() {
    $title = t("Add Charging Station");
    $node_type = 'charging_station';
    $charging_station_form = get_aitico_node_form($node_type);
    return theme('content_entry_page', array('form_title' => $title, 'node_add_form' => $charging_station_form));
}

/**
 * Rendering tree node list view
 * 
 * @return template 
 */
function company_render() {
    $model = get_model();
    $nodes = $model->getTreeNode();
    //return theme('company_template', array("nodes" => $nodes));
    return $nodes;
}

/**
 * Company form 
 * 
 * @return template
 */
function company_form($nid = null) {
    $node_type = "company";
    $form = get_aitico_node_form($node_type);

    return theme('company_form', array('form' => $form));
}

/**
 * Binding node form 
 * 
 * @global User $user
 * @param node $node_type
 * @return form
 */
function get_aitico_node_form($node_type) {
    $node = new stdClass();
    $form_id = $node_type . '_node_form';
    global $user;

    $node->uid = $user->uid;
    $node->name = (isset($user->name) ? $user->name : '');
    $node->type = $node_type;
    $node->language = '';

    node_object_prepare($node);
    $form_output = render(drupal_get_form($form_id, $node));

    return $form_output;
}

/**
 * Add user form
 * @param $form 
 * @param &$form_state
 */
function aitico_core_user_form($form, &$form_state, $companyId, $siteId) {
    global $user;
    $form['#validate'][] = 'aitico_core_user_form_validate';
    $form['#companyId'] = $companyId;
    $form['#siteId'] = $siteId;
    // Account information.
    $form['account'] = array(
        '#type' => 'container',
        '#weight' => -10,
    );
    $form['account']['name'] = array(
        '#type' => 'textfield',
        '#title' => t('Name'),
        '#required' => TRUE,
    );
    $form['account']['mail'] = array(
        '#type' => 'textfield',
        '#title' => t('Email'),
        '#maxlength' => EMAIL_MAX_LENGTH,
        '#required' => TRUE,
    );

    $form['account']['pass'] = array(
        '#type' => 'password_confirm',
        '#size' => 25,
        '#required' => TRUE,
    );

    $options = getRoles();
    $form['account']['roles'] = array(
        '#type' => 'select',
        '#options' => $options,
        '#title' => t('Roles'),
        '#required' => TRUE,
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save User'),
    );

    return $form;
}

/**
 * Add user form
 * @param $form
 * @param $form_state
 * @param $account
 */
function aitico_core_user_edit_form($form, &$form_state, $account) {
    global $user;

    $form['#account'] = $account;
    $form_state['#account'] = $account;
    // Account information.
    $form['account'] = array(
        '#type' => 'container',
        '#weight' => -10,
    );
    $form['account']['name'] = array(
        '#type' => 'textfield',
        '#title' => t('Name'),
        '#required' => TRUE,
        '#default_value' => ($account ? $account->name : ''),
    );
    $form['account']['mail'] = array(
        '#type' => 'textfield',
        '#title' => t('Email'),
        '#maxlength' => EMAIL_MAX_LENGTH,
        '#required' => TRUE,
        '#default_value' => ($account ? $account->mail : ''),
    );

    $form['account']['pass'] = array(
        '#type' => 'password_confirm',
        '#size' => 25,
    );

    $options = getRoles();
    $form['account']['roles'] = array(
        '#type' => 'select',
        '#options' => $options,
        '#title' => t('Roles'),
        '#required' => TRUE,
        '#default_value' => ($account ? array_keys($account->roles) : ''),
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save User'),
    );

    return $form;
}

/**
 * 
 * @global User $user
 * @return $options
 */
function getRoles() {
    global $user;
    // the permissions list
    $roles = array();
    // now get all permissions of logged in user
    $sql = "select rp.permission pr
             from users u, users_roles ur, role r, role_permission rp 
             where u.uid=ur.uid 
             and ur.rid = r.rid 
             and r.rid = rp.rid 
             and r.rid !=2
             and u.uid=" . $user->uid;
    $rows = db_query($sql);

    $roleNames = "";
    foreach ($rows as $row) {
        if ($row->pr == CREATE_SUPERADMIN) {
            // get superadmin role
            $roleNames = $roleNames . "'" . SUPER_ADMIN . "'" . ',';
        }
        if ($row->pr == CREATE_SUPERCONTENTADMIN) {
            // get supercontentadmin role
            $roleNames = $roleNames . "'" . SUPER_CONTENTADMIN . "'" . ',';
        }
        if ($row->pr == CREATE_COMPANYADMIN) {
            // get companyadmin role
            $roleNames = $roleNames . "'" . COMPANY_ADMIN . "'" . ',';
        }
        if ($row->pr == CREATE_CONTENTADMIN) {
            // get contentadmin role
            $roleNames = $roleNames . "'" . CONTENT_ADMIN . "'" . ',';
        }
        if ($row->pr == CREATE_OPERATOR) {
            // get operator role
            $roleNames = $roleNames . "'" . OPERATOR . "'" . ',';
        }
    }

    $options = array();
    if ($roleNames != "") {
        $lastComa = strripos($roleNames, ",");
        $roleNames = substr($roleNames, 0, $lastComa);
        // now get the role list from db
        $roleSql = "select rid, name 
                    from role
                    where name in (" . $roleNames . ")";
        $roleRows = db_query($roleSql);
        foreach ($roleRows as $row) {
            $options[$row->rid] = t($row->name);
        }
    }

    return $options;
}

/**
 * Password change form.
 */
function aitico_core_password_form($form, &$form_state, $account) {

    global $user;
    $form['#account'] = $account;
    $form_state['#account'] = $account;
    $form['#user'] = $account;
    $current_pass_description = t('Enter your current password to change the  %pass.', array('%pass' => t('password')));

    $form['account']['current_pass'] = array(
        '#type' => 'password',
        '#title' => t('Current password'),
        '#size' => 25,
        '#required' => TRUE,
        '#description' => $current_pass_description,
        '#attributes' => array('autocomplete' => 'off'),
    );

    $form['account']['pass'] = array(
        '#type' => 'password_confirm',
        '#size' => 25,
        '#required' => TRUE,
        '#description' => t('To change the current user password, enter the new password in both fields.'),
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save'),
    );

    return $form;
}

/*
 * Implementation of admin page callback
 */

function aitio_core_admin_page() {
    $company_list = theme('aitico-company-list', array('nodes' => company_render()));
    $admin_action = theme('aitico-admin-action', array());
    return theme('aitico-admin-page', array('company_list' => $company_list, 'admin_action' => $admin_action));
}

/*

 * Implementation of admin action edit
 * 
 */

function edit_admin_action() {
    return theme('aitico-admin-action-edit', array());
}

/*
 * Implementation of admin action files
 * 
 */

function get_files_admin_action() {
    return theme('aitico-admin-action-files', array());
}

/*
 * Implementation of admin action file admin
 * 
 */

function admin_file_admin_action() {
    return theme('aitico-admin-action-file-admin', array());
}

/*
 * Implementation of admin action user list
 * 
 */

function get_users_admin_action($company_id, $site_id) {
    $user_lists = user_render($company_id, $site_id);
    return theme('aitico-admin-action-users', array(
                'user_lists' => $user_lists,
                'company_id' => $company_id,
                'site_id' => $site_id,
            ));
}

/*
 * Implementation of admin action logs
 * 
 */

<<<<<<< .mine
function get_logs_admin_action($company_id, $site_id, $cst_id) {
    return theme('aitico-admin-action-logs', array(
                'company_id' => $company_id,
                'site_id' => $site_id,
                'cst_id' =>$cst_id,
            ));
=======
function get_logs_admin_action() {
    return theme('aitico-admin-action-logs', array());
>>>>>>> .r130
}
/**
 * Implementation of logs view page
 * 
 */
function get_all_log_info(){
   
   $company_id = arg(2);
   $site_id = arg(3);
   $cst_id = arg(4);

   $company_node = node_load($company_id);
   $company_name = $company_node->title;
   if($site_id != 0){
   $site_node = node_load($site_id);
   $site_name = $site_node->title;
   } else {
     $site_name = '';  
   }
  /***********/       
        $query = "SELECT
            n.nid AS nid,
            n.type AS type,
            site.entity_id AS site_entity_id,
            cst.entity_id AS cst_entity_id,(SELECT n.title FROM node n where n.nid = cst.entity_id) as cst_title,
            dev.entity_id AS dev_entity_id,(SELECT n.title FROM node n where n.nid = dev.entity_id) as device_title,
            log.entity_id AS log_entity_id
                FROM
                    node n 
            LEFT OUTER JOIN field_data_field_parent_company site
            ON
                    n.nid=site.field_parent_company_target_id 
            LEFT OUTER JOIN field_data_field_parent_site cst
            ON
                    site.entity_id = cst.field_parent_site_target_id 
            LEFT OUTER JOIN field_data_field_charging_station dev
            ON
                    cst.entity_id=dev.field_charging_station_target_id 

            LEFT OUTER JOIN field_data_field_device log
            ON
                    dev.entity_id=log.field_device_target_id
            WHERE n.nid= $company_id";
            
            if ($site_id != 0) {
            $query .= " AND site.entity_id = $site_id";
            }

            if ($cst_id != 0) {
            $query .= " AND cst.entity_id = $cst_id";
            }
            
            $query .=" AND log.entity_id !=''";

           $results = db_query($query)->fetchAll();
           
   /**************/
    
    return theme('aitico-logs-view' , array(
        'company_name' => $company_name,
        'site_name' => $site_name,
        'log_results' => $results
    ));
}
/*
 * Implementation of admin action logo
 * 
 */

function get_logo_admin_action() {
    return theme('aitico-admin-action-logo', array());
}

/*
 * Implementation of admin page callback
 */

function aitio_core_help_page() {
    return '';
}

/*
 * Implementation of admin page callback
 */

function aitio_core_rent_page() {
    return '';
}

/**
 * Get a site id list by a company
 * @param int $nid
 * @return type 
 */
function get_all_child_site_of_a_company($nid) {
    $type = "site";
    $sql = "SELECT n.nid FROM {node} n LEFT JOIN  {field_data_field_parent_company} pc ON  pc.entity_id = n.nid 
            WHERE pc.field_parent_company_target_id = :nid AND n.type = :type";
    $site_list = db_query($sql, array(':nid' => $nid, ':type' => $type))->fetchAll();
    return $site_list;
}

/**
 * Get CST id list by a company id
 * @param type $site_id_lists
 * @return type 
 */
function get_all_charging_station_of_a_company($site_id_lists) {
    $type = "charging_station";
    $sql = "SELECT n.nid FROM {node} n LEFT JOIN  {field_data_field_parent_site} ps ON  ps.entity_id = n.nid 
            WHERE ps.field_parent_site_target_id IN($site_id_lists) AND n.type = :type";
    $charging_station_list = db_query($sql, array(':type' => $type))->fetchAll();
    return $charging_station_list;
}

/**
 * Get CST id list by a site id
 * @param type $site_id
 * @return type 
 */
function get_all_charging_station_of_a_site($site_id) {
    $type = "charging_station";
    $sql = "SELECT n.nid FROM {node} n LEFT JOIN  {field_data_field_parent_site} ps ON  ps.entity_id = n.nid 
            WHERE ps.field_parent_site_target_id = :site_id AND n.type = :type";
    $charging_station_list = db_query($sql, array(':site_id' => $site_id, ':type' => $type))->fetchAll();
    return $charging_station_list;
}

/*
 * Implementation of updating admin action in right block based on
 * clicking on left block 
 * 
 */

function update_admin_action() {
    $company_id = $_POST['company_id'];
    $site_id = $_POST['site_id'];
<<<<<<< .mine
    $cst_id = $_POST['cst_id'];  
    //print $cst_id;exit;
    $output = '';    
=======
    $cst_id = $_POST['cst_id'];
    $output = '';
>>>>>>> .r130
    $admin_action_edit = edit_admin_action();
    $admin_action_files = get_files_admin_action();
    $admin_action_file_admin = admin_file_admin_action();
    $admin_action_logs = get_logs_admin_action($company_id,$site_id,$cst_id);
    $admin_action_users = get_users_admin_action($company_id, $site_id);
    $admin_action_logo = get_logo_admin_action();

    $output.= $admin_action_edit;
    $output.= $admin_action_files;
    $output.= $admin_action_file_admin;
    $output.= $admin_action_logs;
    $output.= $admin_action_users;
    $output.= $admin_action_logo;

    return aitico_core_ajax_reply(true, $output);
}