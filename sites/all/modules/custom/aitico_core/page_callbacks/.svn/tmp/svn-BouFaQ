<?php

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

function aitico_core_schedule_page($cst_id) {

    //get cst info
    $cst_node = node_load($cst_id);
    $cst_title = $cst_node->title;
    $site_id = $cst_node->field_parent_site['und'][0]['target_id'];

    //get site info
    $site_node = node_load($site_id);
    $site_title = $site_node->title;
    $company_id = $site_node->field_parent_company['und'][0]['target_id'];

    //get company info
    $company_node = node_load($company_id);
    $company_title = $company_node->title;

    $title = 'Schedule';
    $all_group_name = get_all_files_group($cst_id);
    
    //get first group id
    $initial_group = array_shift(array_values($all_group_name));
    $initial_group_id = $initial_group->nid;
    
    //get schedule info
    $schedule_info = get_all_schedule_info_by_group($initial_group_id);
    
   // print_r($schdule_info);exit;
    return theme('aitico-core-schedule', array(
                'title' => $title,
                'cst_title' => $cst_title,
                'site_title' => $site_title,
                'company_title' => $company_title,
                'group_lists' => $all_group_name,
                'schedule_info' => $schedule_info
            ));
}

/**
 * Get all files group for a cst
 * 
 */
function get_all_files_group($cst_id) {
    $query = "SELECT n.nid,n.title FROM {node} n ,{field_data_field_cst} cst 
                WHERE cst.entity_id = n.nid AND cst.field_cst_target_id = $cst_id";

    $results = db_query($query)->fetchAll();

    return $results;
}

/**
 * Get all slot for a group
 * @param type $file_group_id
 * @return type 
 */
function get_all_slot_of_a_group($file_group_id) {
    $query = "SELECT n.* FROM  {node} n ,{field_data_field_filegroup} fg 
                WHERE fg.entity_id = n.nid AND fg.field_filegroup_target_id = $file_group_id";
    $results = db_query($query)->fetchAll();

    return $results;
}

/**
 * Add a blank row in schedule page
 * @param type $file_group_id
 * @return type 
 */
function aitico_core_add_blank_schedule($file_group_id) {

    $file_slot = get_all_slot_of_a_group($file_group_id);
    $slot_number = count($file_slot);
    $file_schedule = get_file_schedule($file_group_id);
    

    $schedule_row = theme('aitico-schedule-add-row', array('file_group_id' => $file_group_id,
        'slot_number' => $slot_number,
        'file_slots' => $file_slot , 
        'file_schedule_id' => $file_schedule->nid)
    );


    return ajax_deliver(array(
                '#type' => 'ajax',
                '#commands' => array(ajax_command_append('#schedule-table tbody', $schedule_row),
                    )));
}

/**
 * Add table while group changes
 * @param type $file_group_id
 * @return type 
 */
function aitico_core_group_schedule($file_group_id) {
    $file_slot = get_all_slot_of_a_group($file_group_id);
    $slot_number = count($file_slot);
    
    //get schedule info
    $schedule_info = get_all_schedule_info_by_group($file_group_id);

    $group_info = theme('aitico-schedule-view-group', 
            array('file_group_id' => $file_group_id, 
                'slot_number' => $slot_number, 
                'file_slots' => $file_slot,
                'schedule_info'=>$schedule_info));

    $output = '<table class="table table-bordered table-hover" id="schedule-table">' . $group_info . '</table>';
    return ajax_deliver(array(
                '#type' => 'ajax',
                '#commands' => array(ajax_command_replace('#schedule-table', $output),
                    )));
}



/*
 * Update Schedule Information 
 */

function update_schedule_info($schedule_id){   
    
    $date_str = $_POST['date'];
    $time_str = $_POST['time'];    
    $date_time = $date_str.' '.$time_str;        
    $date_to_timestamp = strtotime($date_time);    
    $schedule_node = node_load($schedule_id);  
    $schedule_node->field_schedule_time['und'][0]['value'] = $date_to_timestamp;
    node_save($schedule_node);
   
    
}
/**
 * get schedule info by group id
 * @return type 
 * 
 */
function get_all_schedule_info_by_group($group_id){
    
    $query = "SELECT n.nid as schedule_file_id,n.type,
                    fs.field_file_schedule_target_id as parent_schedule_id,
                    field_slot_target_id as parent_slot_id,
                    st.field_schedule_time_value as schedule_time
                FROM {node} n 
                LEFT JOIN {field_data_field_file_schedule} fs ON fs.entity_id = n.nid
                LEFT JOIN {field_data_field_parent_file_group} fg ON fg.entity_id = fs.field_file_schedule_target_id
                LEFT JOIN {field_data_field_slot} sl ON sl.entity_id = n.nid
                LEFT JOIN {field_data_field_schedule_time} st ON  st.entity_id = fs.field_file_schedule_target_id
                WHERE n.type = 'files' AND fs.field_file_schedule_target_id!=''                 
                AND fg.field_parent_file_group_target_id = $group_id ";
    
    $results = db_query($query)->fetchAll();
    
    $schedule_info = array();
    $schedule_id = 0;
    foreach($results as $row){
        if($row->parent_schedule_id != $schedule_id)
            $schedule_id = $row->parent_schedule_id;
            
            $schedule_info[$schedule_id]['schedule_time'] = $row->schedule_time;
            $schedule_info[$schedule_id]['files_info'][] = $row;
    }
    return $schedule_info;
}


/**
 *
 * @param type $cst_id
 * @param type $node_id
 * @return type 
 */
function aitico_core_remove_schedule_file($file_group_id, $node_id) {
    $node = node_load($node_id);
    unset($node->field_file);
    node_save($node);    
    aitico_core_group_schedule($file_group_id);
}


/**
 * Refreshing file
 * 
 * @param type $cst_id
 * @return type 
 */
function refresh_schedule_files($file_group_id) {    
    aitico_core_group_schedule($file_group_id);
   
}

